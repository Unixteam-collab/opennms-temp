#!/bin/bash

EXTREPO=pgdg11
LOCAL_MIRROR="ol7_x86_64_postgres_11"
PGINSTALLED="/opt/opennms/.ABBCS_Config_defaults/postgresql11.installed"


if [ -f $PGINSTALLED ]
then
   echo PostgreSQL 11 already configured.
else
   PSQLV=$(psql --version | cut -d \  -f 3 | cut -d. -f 1)

   echo Installing PostgreSQL 11
 
   # check repo config.
   yum repolist | grep $LOCAL_MIRROR > /dev/null 2>&1

   if [ $? != 0 ]
   then
      ENABLE_PG_REPO="--enablerepo=$EXTREPO"
   else
      ENABLE_PG_REPO=''
   fi

   yum $ENABLE_PG_REPO install -y postgresql11-server
   
   if [ $? != 0 ]
   then
      echo Failure to install Postgresql 11 - ABORTING
      exit 1
   fi
   
   echo extracting LC_CTYPE
   systemctl start postgresql
   LANG=$(echo $(su postgres -c 'psql -c "show lc_ctype"' | head -3 | tail -1))
   echo got $LANG
   systemctl stop postgresql
   PGSETUP_INITDB_OPTIONS=--locale=$LANG
   export PGSETUP_INITDB_OPTIONS
   echo initializing new db
   /usr/pgsql-11/bin/postgresql-11-setup initdb


   echo return value $?
 
   if [ "$PSQLV" -lt 11 ]
   then

      echo Migrating to PostgreSQL 11
      #DBLOC=$(su - postgres -c "pg_ctl status" | tail -1 | cut -d \"  -f 4)
      SOURCE=$(systemctl show -p Environment postgresql |sed 's/^Environment=//' | tr ' ' '\n' |sed -n 's/^PGDATA=//p' | tail -n 1)
      DEST=/var/lib/pgsql/11/data
      echo ensuring postgresql is down
      su postgres -c "/usr/bin/pg_ctl -D $SOURCE stop"
      su postgres -c "/usr/pgsql-11/bin/pg_ctl -D $DEST stop"

      echo everything should be down by now
      echo PSQLV = $PSQLV
      if [[ $PSQLV == 9 ]]
      then
         echo got psql v9 hacking pg_ctl
         # hack to fix change of parameter between 9.2 and 9.3
         mv /usr/bin/pg_ctl  /usr/bin/pg_ctl-orig
         echo '#!/bin/bash' > /usr/bin/pg_ctl
         echo '"$0"-orig "${@/unix_socket_directory/unix_socket_directories}"' >> /usr/bin/pg_ctl
         echo >> /usr/bin/pg_ctl
         chmod +x /usr/bin/pg_ctl
      fi
      echo about to do datamigration
      echo su - postgres -c '/usr/pgsql-11/bin/pg_upgrade --old-datadir "'$SOURCE'"  --new-datadir "'$DEST'" --old-bindir "/usr/bin" --new-bindir "/usr/pgsql-11/bin"'
      su - postgres -c '/usr/pgsql-11/bin/pg_upgrade --old-datadir "'$SOURCE'"  --new-datadir "'$DEST'" --old-bindir "/usr/bin" --new-bindir "/usr/pgsql-11/bin"'
      if [[ $PSQLV == 9 ]]
      then
         mv -f /usr/bin/pg_ctl-orig /usr/bin/pg_ctl
         /opt/opennms/scripts/fix_pglinks.sh
      fi 


      echo disabling old version of postgresql
      systemctl disable postgresql
      systemctl disable postgresql-10

      yum -y remove postgresql postgresql-server postgresql-libs
      # restore postgresql-11 bash_profile removed by previous yum remove command
      mv /var/lib/pgsql/.bash_profile.rpmsave /var/lib/pgsql/.bash_profile


   fi

   echo enabling postgresql 11
   systemctl enable postgresql-11.service
   echo starting postgresql 11
   systemctl start postgresql-11.service
   if [ -f /var/lib/pgsql/11/data/analyze_new_cluster.sh ]
   then 
      echo analyzing new cluster
      su - postgres -c "/var/lib/pgsql/11/data/analyze_new_cluster.sh"
   fi

   rpm -q postgresql11
   if [ $? = 0 ]
   then
      echo PostgreSQL 11 installed
      ps -ef | grep [p]ostgre
      if [ $? = 0 ]
      then
         echo PostgreSQL 11 running\; installation and configuration appears to have succeeded
         touch $PGINSTALLED
      else
         echo PostgreSQL 11 not running\; configuration failure
      fi
   else
      echo PostgreSQL 11 not installed\; installation failure
   fi
fi

